pipeline {
    agent { label 'bpy-agent'}
    environment {
        BASE_URL = 'http://192.8.8.133:8080/'
        PROJECT_ID = 'a9fdba48-8083-469d-9037-df5765b619c6'
        REPORT_PATH = "./testResult/output.xml"
    }
    
    stages {
        stage('Setup environment and devices'){
            steps {
                script{
                    common = load "$WORKSPACE/common.groovy"
                    common.stop_appium()
                    common.kill_all_ios_simu()
                    common.start_all_ios_simu()

                    sh '''
                        cd ~/.appium/node_modules/appium-xcuitest-driver/node_modules/appium-webdriveragent/
                        xcodebuild -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner -destination 'id=DF56FB4B-F02F-4E10-8592-7BE929F8E5D0' -allowProvisioningUpdates test &
                        sleep 10
                    '''

                    common.start_appium()
                    
                }
            }
        }
        stage('Assign BPY 03') {
            steps {
                script{
                    echo "Test iOS"
                    sh(script: 'pabot --pabotlib --resourcefile ./ios_resource_file.dat --processes 2 -d testResult -v PLATFORM_NAME:ios robot-mobile/test-cases/.', returnStatus: true)
                    robot outputPath: './testResult', otherFiles: '*.png,*.jpg', logFileName: 'log.html', outputFileName: 'output.xml', reportFileName: 'report.html'
                    archiveArtifacts artifacts: 'testResult/*.html, testResult/*.jpg, testResult/*.png, testResult/*.xml', fingerprint: true, onlyIfSuccessful: false

                    common = load "$WORKSPACE/common.groovy"
                    // common.result_jenkins_slack("#cicd_training_space", "[iOS]")
                    // common.result_jenkins_line()
                    // common.report_sender()
                }
            }
        post{
            always{
                    cleanWs()
                    echo "Clear"
                }
            }
            
            }
        }
    }