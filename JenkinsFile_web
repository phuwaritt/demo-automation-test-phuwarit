def notify_line(total_tests, passed_count, failed_count, log_url, BRANCH_NAME, JOB_NAME){
    def token = "lWcrOHVVskzMYRXb7iB1e9xanhcvmC3Pu8Jz39Ozufh"
    def url = 'https://notify-api.line.me/api/notify'
    def message = "BPY ðŸ”¥ \n${JOB_NAME} #${env.BUILD_NUMBER}\nBranch: ${BRANCH_NAME} \nBuild #${env.BUILD_NUMBER}\nTotal Test Cases: ${total_tests}\nPassed : ${passed_count} âœ… \nFailed : ${failed_count} ðŸ¤® \nAfter: ${currentBuild.durationString} \n\nReport: (${log_url})"
    sh "curl ${url} -H 'Authorization: Bearer ${token}' -F 'message=${message}'"
}

pipeline {
    agent { label 'bpy-agent'}
    environment {
        BASE_URL = 'http://192.8.8.133:8080/'
    }
    stages {
        stage('Assign BPY 01') {
            steps {
                script{
                sh(script: 'pabot --pabotlib --testlevelsplit --processes 3 -d testResult test-project-web-robotframework/testscripts/tc_shopping_carts_scripts.robot', returnStatus: true)
                archiveArtifacts artifacts: 'testResult/*.html, testResult/*.jpg, testResult/*.png, testResult/*.xml', fingerprint: true, onlyIfSuccessful: false
                robot outputPath: './testResult', otherFiles: '*.png,*.jpg', logFileName: 'log.html', outputFileName: 'output.xml', reportFileName: 'report.html'
                    String passed_count =  tm('${ROBOT_PASSED}')
                    String failed_count = tm('${ROBOT_FAILED}')
                    String BRANCH_NAME = "${GIT_BRANCH}"
                    String JOB_NAME = "${env.JOB_NAME}"
                    echo "Passed Tests: ${passed_count}"
                    echo "Failed Tests: ${failed_count}"
                    
                    def total_tests = passed_count.toInteger() + failed_count.toInteger()
                    def log_url = "${env.BASE_URL}/job/${JOB_NAME}/${env.BUILD_NUMBER}/"
                    slackSend(channel:"#cicd_training_space",message: "BPY :jenkins-masked: ${env.JOB_NAME} #${env.BUILD_NUMBER} \n *BRANCH:* ${BRANCH_NAME} \n Total Test Cases: ${total_tests} \n Passed : ${passed_count} :white_check_mark: \n Failed : ${failed_count} :face_vomiting: \n After: ${currentBuild.durationString} \n (<${log_url}|Report>)")
                    notify_line(total_tests, passed_count, failed_count, log_url, BRANCH_NAME, JOB_NAME)
                }
            }
        post{
            always{
                cleanWs()
                echo "Clear"
                }
            }
            
            }
        }
    }